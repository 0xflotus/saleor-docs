---
title: OpenIDConnectPlugin
---

import Chart from "@site/components/Chart";

## Key Concepts

OpenIDConnectPlugin allows you to integrate with your OAuth provider. 
This will allow you to move the authentication process to an external provider.
Saleor will require the scopes:
 - openid
 - profile
 - email
 - offline\_access - _optionally, when you enable refreshing the token_
 - saleor:_permission_ - _optionally when you enable mapping OAuth permissions to Saleor_


## Actions

The plugin provides below actions. 

### External authentication
#### Mutation
The `externalAuthentication` mutation will generate an authorization URL.
The mutation takes the following input fields:
- `redirectUrl`: the URL where the user should be redirected after successful authentication

The `token` will be added to the `redirectUrl` as a GET parameter. If refreshing the token is enabled, `refreshToken` and `csrfToken`
will be also added as a GET parameters.

```graphql
mutation {
  externalAuthentication(input:"{\"redirectUrl\": \"http://localhost:3000\"}"){
    authenticationData
    accountErrors{
      field
      message
    }
  }
}
```

A successful response:

```json
{
  "data": {
    "externalAuthentication": {
      "authenticationData": "{\"authorizationUrl\": \"https://saleor-test.eu.auth0.com/authorize?response_type=code&client_id=RUgv72Cvzd5xjlMtgOEQLJ8QF4eQ3e1U&redirect_uri=http%3A%2F%2Flocalhost%3A8000%2Fplugins%2Fmirumee.authentication.openidconnect%2Fcallback&scope=openid+profile+email+offline_access&state=eyJyZWRpcmVjdFVybCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCJ9%3A1kQQVm%3AXKUdkjMug8wDDTNEshGgE1iFNEstifj7JzI9r-10P7A\"}",
      "accountErrors": []
    }
  }
}
```

#### Workflow
<Chart
  definition={`
  sequenceDiagram
    Web ->>+ Saleor: ExternalAuthentication mutation with<br> redirect as input (http://localhost:3000/)
    Saleor ->>+ OpenIDConnectPlugin: call external_authentication
    OpenIDConnectPlugin -->>- Saleor: return redirect URL to <br>Oauth provider
    Saleor -->>- Web: Response from plugin
    Web ->>+ OAuthProvider: Redirect to the authorizantion page
    OAuthProvider -->>- OpenIDConnectPlugin: GET<br> /plugins/<br>mirumee.authentication.openidconnect/<br>callback?state=redirectUrl/&code=YYY
    OpenIDConnectPlugin ->>+ OAuthProvider: fetch tokens
    OAuthProvider -->>- OpenIDConnectPlugin: tokens
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: validate tokens
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: create internal tokens with granted permissions
    OpenIDConnectPlugin -->> Web: set cookie refreshToken with <br>refresh token and redirect to<br> http://localhost:3000/?token=ZZZ&refreshToken=WWW&csrfToken=EEE
`}
/>

### External refresh
#### Mutation

The `externalRefresh` mutation will generate a new access token when provided with a valid refresh token. 
If the refresh token is not provided as an argument, the code will try to read it from a cookie set by the tokenCreate mutation. In that case, matching CSRF token is required.

The mutation takes the following input fields:
- `refreshToken`: the refresh token which should be used to refresh the access token
- `csrfToken`: required when `refreshToken` is not provided as an input


```graphql
mutation{
  externalRefresh(input:"{\"refreshToken\": \"ABCDE\"}"){
    refreshedData
    accountErrors{
      field
      message
      code
    }
  }
}
```

A successful response:
```json
{
  "data": {
    "externalRefresh": {
      "refreshedData": "{\"token\": \"new-token\", \"refreshToken\": \"new-refresh-token\", \"csrfToken\": \"new-csrf-token\"}",
      "accountErrors": []
    }
  }
}
```
#### Workflow
<Chart
  definition={`
  sequenceDiagram
    Web ->>+ Saleor: ExternalRefresh mutation with<br> refreshToken and CSRF token as input ยน
    Saleor ->>+ OpenIDConnectPlugin: call <br>PluginManager.external_refresh
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: validate CSRF and <br>refresh token structure
    OpenIDConnectPlugin ->>+ OAuthProvider: refresh tokens
    OAuthProvider -->>- OpenIDConnectPlugin: new tokens
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: create new internal tokens
    OpenIDConnectPlugin -->>- Saleor: new tokens
    Saleor ->>- Web: return access_token<br> and refresh_token
`}
/>

> ยน refresh token can be also passed as a cookie - refreshToken

### External verify
#### Mutation
To verify the token, use the following mutation.

```graphql
mutation{
  externalVerify(input:"{\"token\": \"token-to-check\"}"){
    isValid
    verifyData
    user{
      email
      userPermissions{
        code
        name
      }
    }
    accountErrors{
      field
      message
      code
    }
  }
}
```

A successful response:
```json
{
  "data": {
    "externalVerify": {
      "isValid": true,
      "verifyData": "{\"iat\": 1602143144, \"token\": \"xgS4ZELKlUHQ\", \"email\": \"admin@example.com\", \"type\": \"access\", \"user_id\": \"VXNlcjoyNQ==\", \"is_staff\": false, \"exp\": 1602179144, \"oauth_access_key\": \"tM-LHXMbxP5IANhPUd24_y5jjv0SCSj2\", \"owner\": \"mirumee.authentication.openidconnect\"}",
      "user": {
        "email": "admin@example.com",
        "userPermissions": []
      },
      "accountErrors": []
    }
  }
}
```
#### Workflow
<Chart
  definition={`
  sequenceDiagram
    Web ->>+ Saleor: ExternalVerify mutation with<br> token as input
    Saleor ->>+ OpenIDConnectPlugin: call <br>PluginManager.external_verify
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: decode token
    OpenIDConnectPlugin -->>- Saleor: return assigned user<br> and payload data
    Saleor ->>- Web: return token data
`}
/>

### External logout
You can prepare the logout URL by calling `externalLogout` mutation. 
Based on your OAuth provider you can pass all mandatory fields which will be added 
as a GET parameter to the logout request. 

#### Mutation
```graphql
mutation {
  externalLogout(input:"{\"returnTo\": \"http://localhost:3000\"}"){
    logoutData
    accountErrors{
      field
      message
      code
    }
  }
}
```
A successful response:
```json
{
  "data": {
    "externalLogout": {
      "logoutData": "{\"logoutUrl\": \"https://saleor-test.eu.auth0.com/v2/logout?returnTo=http%3A%2F%2Flocalhost%3A3000\"}",
      "accountErrors": []
    }
  }
}
```
#### Workflow
<Chart
  definition={`
  sequenceDiagram
    Web ->>+ Saleor: ExternalLogout mutation with<br> data required to logout
    Saleor ->>+ OpenIDConnectPlugin: call <br>PluginManager.external_logout
    OpenIDConnectPlugin ->>OpenIDConnectPlugin: prepare logout URL:<br> logoutUrl + input data as GET params
    OpenIDConnectPlugin -->>- Saleor: return logoutData
    Saleor ->>- Web: return logoutData
`}
/>

## User authentication flow
<Chart
  definition={`
  sequenceDiagram
    Web ->>+ Saleor: request to protected resources with token
    Saleor ->>+ OpenIDConnectPlugin: authentication backend calls <br>Plugin.authenticate_user
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: decode and validate token
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: get user
    OpenIDConnectPlugin ->> OpenIDConnectPlugin: assign permissions <br>from token
    OpenIDConnectPlugin ->>- Saleor: user authenticated
    Saleor ->>- Web: requested resources
`}
/>

## OAuth permissions
Saleor can use OAuth permissions assigned to a user. It maps internal permissions to OAuth scopes and attaches 
it to the authorization request.


### OAuth permission scopes
| OAuth scope name                                | Saleor Name                 | Description                                                                                                                      |
| ----------------------------------------------- | --------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| saleor:manage_staff                             | MANAGE_STAFF                | Access to staff users data                                                                                                       |
| saleor:manage_apps                              | MANAGE_APPS                 | Manage apps                                                                                                                      |
| saleor:manage_users                             | MANAGE_USERS                | Access to customers data                                                                                                         |
| saleor:manage_discounts                         | MANAGE_DISCOUNTS            | Manage discounts                                                                                                                 |
| saleor:manage_plugins                           | MANAGE_PLUGINS              | Manage plugins                                                                                                                   |
| saleor:manage_gift_card                         | MANAGE_GIFT_CARD            | Manage gift cards                                                                                                                |
| saleor:manage_menus                             | MANAGE_MENUS                | Manage the structure of menus                                                                                                    |
| saleor:manage_orders                            | MANAGE_ORDERS               | Access to orders data                                                                                                            |
| saleor:manage_pages                             | MANAGE_PAGES                | Manage pages                                                                                                                     |
| saleor:manage_product                           | MANAGE_PRODUCTS             | Manage products                                                                                                                  |
| saleor:manage_product_types_and_attributes      | MANAGE_PRODUCT_TYPES_AND_ATTRIBUTES             | Manage products                                                                                                                  |
| saleor:manage_shipping                          | MANAGE_SHIPPING             | Manage shipping                                                                                                                  |
| saleor:manage_settings                          | MANAGE_SETTINGS             | Manage shop settings                                                                                                             |
| saleor:manage_translations                      | MANAGE_TRANSLATIONS         | Manage tranlsations                                                                                                              |
| saleor:manage_checkouts                         | MANAGE_CHECKOUTS            | Manage checkout                                                                                                                  |


If _Use OAuth scope permissions_ is enabled, any permissions granted to a user on the 
authentication provider side will be used as the effective permissions on the Saleor side. 
Please see the documentation of your authentication server to see how to manage permissions 
and how to configure role-based access control (RBAC).
